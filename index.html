<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Webmatrix.executer by MacawNL</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Webmatrix.executer</h1>
          <h2>Simply create WebMatrix 2 extensions that execute commands, capture output and parse for errors and warnings.</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/MacawNL/WebMatrix.Executer/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/MacawNL/WebMatrix.Executer/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/MacawNL/WebMatrix.Executer" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>WebMatrix.Executer</h1>

<h2>Introduction</h2>

<p>The WebMatrix Extensibility Model does not support out of the box the executing
of applications and scripts, an output pane, and an Error List pane that may 
be used by WebMatrix Extension Writers. Although there is an Error List pane 
available, this pane may not be used by custom extensions.</p>

<p><strong>WebMatrix.Executer</strong> provides a library that can be included in your own baked
WebMatrix extension to execute applications and PowerShell scripts, send 
the output in realtime to a WebMatrix <strong>Output</strong> pane, and parse the output for 
errors and warnings that are displayed in a WebMatrix <strong>Errors &amp; Warnings</strong> pane
with just a few lines of code. Multiple extensions using <strong>WebMatrix.Executer</strong>
will use the same panes.</p>

<h2>The provided functionality</h2>

<p><strong>WebMatrix.Executer</strong> provides two panes:</p>

<ul>
<li>The Output pane where the output of an executing program is captured (StdOut, StdErr)</li>
<li>The Errors &amp; Warnings pane where the errors and warnings found by parsing the output are reported</li>
</ul><p><strong>WebMatrix.Executer</strong> can execute applications and PowerShell scripts asynchronuously, and capture 
the output and the errors &amp; warnings in realtime to the two panes.
Applications and scripts are executed under a "task source", this is a simple string identifier that specifies
to which "group" an application or script belongs. The <strong>Output</strong> pane can be switched to the output of a task 
source, the <strong>Errors &amp; Warnings</strong> pane can be filtered on the task source.</p>

<h3>The Output pane</h3>

<p><img src="http://macawnl.github.com/WebMatrix.Executer/img/OutputPane.png" alt="The Output pane"></p>

<ul>
<li>The Output pane support multiple task sources</li>
<li>When an executing task has output, the Output pane is made visible</li>
<li>Output of an executing task (StdOut, StdErr) is displayed real-time</li>
<li>The output per task source can be selected through a drop down box</li>
<li>The output of a task source can be cleared</li>
<li>The output of a task source can be word-wrapped</li>
<li>A task (running program or script) executing under a task source can be canceled</li>
<li>When the output of a task contains errors or warnings, <strong>WebMatrix.Executer</strong> switches
automatically to the Errors &amp; Warnings pane</li>
</ul><h3>The Errors &amp; Warnings pane</h3>

<p><img src="http://macawnl.github.com/WebMatrix.Executer/img//ErrorsAndWarningsPane.png" alt="The Errors &amp; Warnings pane"></p>

<ul>
<li>The Errors &amp; Warnings pane displays the error and warning messages of all task sources</li>
<li>Output of an executing task (StdOut, StdErr) is parsed real-time for erros and warnings</li>
<li>Error and warning messages are visualized using an error and warning icon</li>
<li>The messages can be filtered on task source (all, one), errors, warnings</li>
<li>The messages can be cleared</li>
<li>If a message contains a reference to a file, the path is displayed relative to the root of the WebMatrix (~/...)</li>
<li>If a message contains a reference to a file, and the file can't be resolved, the original file path is displayed</li>
<li>If a message is clicked, the corresponding file is opened in the editor at the correct line (if known) 
and correct column (if known)</li>
<li>If a message is clicked and the file can't be resolved, a message box is displayed specifying the file, line and column</li>
<li>If a message contains an url, the url is used as a help link and a help icon appears</li>
</ul><h2>Background Information</h2>

<p><a href="http://extensions.webmatrix.com/">WebMatrix extensions</a> are <a href="http://msdn.microsoft.com/en-us/library/dd460648.aspx">MEF</a>
extensions that are loaded dynamically from the folder <code>%USERPROFILE%\AppData\Local\Microsoft\WebMatrix\Extensions\20</code>.
WebMatrix extensions are easy to develop. The <a href="http://extensions.webmatrix.com/documentation_2">How to Create Extensions</a>
page by Microsoft gets you started with pointers to a Visual Studio template and the WebMatrix Extensibility API documentation.</p>

<p><strong>WebMatrix.Executer</strong> provides a good base when writing extensions that need a kind of "compilation" 
with output and error reporting. Because the <strong>WebMatrix.Executer</strong> functionality could be used by 
multiple extensions, also extensions not written by you, and we don't want multiple output tabs, only 
one version of the code should be running. To accomplish this you will program against an interface 
with available methods that is independent from the actual implementation, and <strong>Webmatrix.Executer</strong>
will make sure that only a single instance of the implementation assembly is running, and that always
the newest version available in all extensions will be running.</p>

<p>The interface is defined in the <code>DesignFactory.WebMatrix.IExecuter.dll</code> assembly . The <code>DesignFactory.WebMatrix.ExecuterFactory.dll</code> 
assembly contains a smart piece of code that makes sure that the first WebMatrix extension that uses <strong>WebMatrix.Executer</strong>,
and that is loaded through MEF, loads the latest version of the <strong>WebMatrix.Executer</strong>
implementation assembly <code>DesignFactory.WebMatrix.Executer.dll</code> as available in each of the extension folders. The interface will never change 
or remove methods signatures, it will only be extended to ensure backwards 
compatibility to older extensions while enabling innovations in 
WebMatrix.Executer itself.</p>

<h2>Distribution of WebMatrix.Executer: NuGet</h2>

<p><strong>WebMatrix.Executer</strong> is distributed as a <a href="http://nuget.org/packages/WebMatrix.Executer">NuGet</a> 
package. The package is named <strong>WebMatrix.Executer</strong>. The <strong>WebMatrix.Executer</strong> NuGet 
package consists of the following assemblies:</p>

<ul>
<li><code>DesignFactory.WebMatrix.IExecuter.dll</code></li>
</ul><p>This is the interface assembly to program against. This assembly will be 
referenced by your project.</p>

<ul>
<li><code>DesignFactory.WebMatrix.ExecuterFactory.dll</code></li>
</ul><p>This assembly contains the <code>ExecuterFactory()</code> function to load the newest version of 
the <code>DesignFactory.WebMatrix.Executer.dll</code> implementation assembly. This 
assembly will be referenced by your project.</p>

<ul>
<li><code>DesignFactory.WebMatrix.Executer.dll</code></li>
</ul><p>This assembly contains the actual implementation of the interface, and the interface 
itself as an embedded type. See for more background information:
<a href="http://msdn.microsoft.com/en-us/library/dd409610.aspx">http://msdn.microsoft.com/en-us/library/dd409610.aspx</a>.
This assembly is NOT referenced, but will be copied to the output directory
alongside your extension assembly, the interface assembly and the factory assembly.</p>

<h2>Using <strong>WebMatrix.Extender</strong> in your extension</h2>

<p>To enable <strong>WebMatrix.Executer</strong> functionality, in your extension,
the extensions needs an implementation as simple as:</p>

<pre><code>namespace MyLittleWebMatrixExtension
{
    /// &lt;summary&gt;
    /// A sample WebMatrix extension.
    /// &lt;/summary&gt;
    [Export(typeof(Extension))]
    public class MyLittleWebMatrixExtension : Extension
    {
        /// &lt;summary&gt;
        /// Stores a reference to the WebMatrix host interface.
        /// &lt;/summary&gt;
        private IWebMatrixHost _webMatrixHost;

        /// &lt;summary&gt;
        /// Reference to the EditorTaskPanelService.
        /// &lt;/summary&gt;
        private IEditorTaskPanelService _editorTaskPanel;

        [Import(typeof(IEditorTaskPanelService))]
        private IEditorTaskPanelService EditorTaskPanelService
        {
            get
            {
                return _editorTaskPanel;
            }
            set
            {
                _editorTaskPanel = value;
            }
        }

        DesignFactory.WebMatrix.IExecuter.IExecuter _executer;

        /// &lt;summary&gt;
        /// Initializes a new instance of the MyLittleWebMatrixExtension class.
        /// &lt;/summary&gt;
        public MyLittleWebMatrixExtension()
            : base("MyLittleWebMatrixExtension")
        {
        }

        /// &lt;summary&gt;
        /// Called to initialize the extension.
        /// &lt;/summary&gt;
        /// &lt;param name="host"&gt;WebMatrix host interface.&lt;/param&gt;
        /// &lt;param name="initData"&gt;Extension initialization data.&lt;/param&gt;
        protected override void Initialize(IWebMatrixHost host, 
                                           ExtensionInitData initData)
        {
            _webMatrixHost = host;

            // Add a simple button to the Ribbon
            initData.RibbonItems.Add(
                new RibbonGroup("DoIt Group",new RibbonItem[]
                   {new RibbonButton("Just DoIt",
                    new DelegateCommand(HandleRibbonButtonInvoke),
                    null, _starImageSmall, _starImageLarge)}));

            _executer = DesignFactory.WebMatrix.ExecuterFactory.GetExecuter(
                            "DoIt", _webMatrixHost, _editorTaskPanel);
        }

        /// &lt;summary&gt;
        /// Called when the Ribbon button is invoked.
        /// &lt;/summary&gt;
        /// &lt;param name="parameter"&gt;Unused.&lt;/param&gt;
        private async void HandleRibbonButtonInvoke(object parameter)
        {
            string scriptDoIt = Path.Combine(_webMatrixHost.WebSite.Path, @"WebMatrixTests\DoIt.bat");
            await _executer.RunAsync("cmd.exe", "/c \"" + scriptDoIt + "\"");
        }       
    }
}
</code></pre>

<p>Note the <code>EditorTaskPanelService</code> stuff, we need this to be able to create the
Output and Errors &amp; Warnings panes.</p>

<p>The <code>DesignFactory.WebMatrix.ExecuterFactory.GetExecuter(...)</code> call requires three
parameters:</p>

<p><code>string tasksource</code>:  Specifies the group name where tasks from this executer
are executed under. This name is shown as selector in the Output pane and
can be used to filter errors and warnings.</p>

<p><code>IWebMatrixHost webMatrixHost</code>: the WebMatrix host, available as parameter to
the <code>Initialize()</code> method in your WebMatrix extension.</p>

<p><code>IEditorTaskPanelService editorTaskPanelService</code>: Reference to the 
<code>EditorTaskPanelService</code>, see example code above on how to get it.</p>

<p>In the <code>GetExecuter(...)</code> call the <strong>WebMatrix.Executer</strong> system is initialized and the tabs are
created for the <strong>Output</strong> pane and <strong>Errors &amp; Warnings</strong> pane.</p>

<p>The call to <code>GetExecuter(...)</code> returns an
instance of an object that implements the following interface:</p>

<pre><code>namespace DesignFactory.WebMatrix.IExecuter
{
    public interface IExecuter
    {
        System.Threading.Tasks.Task&lt;bool&gt; RunAsync(string fileName, 
                                                   string arguments);
        System.Threading.Tasks.Task&lt;bool&gt; RunPowerShellAsync(string arguments);
        bool IsRunning();
        void Cancel();
        void Write(string format, params object[] args);
        void WriteLine(string format, params object[] args);

        // Only used by DesignFactory.WebMatrix.ExecuterFactory.GetExecuter()
        void Initialize(string tasksource, IWebMatrixHost webMatrixHost, 
                        IEditorTaskPanelService editorTaskPanelService);
        void InitializeTabs();
    }
}
</code></pre>

<p>These methods do the following:</p>

<p><code>RunAsync</code>: Execute an application with parameters async. Returns true if
successful, false otherwise. Output (StdOut, Stderr) is written to output pane
and parsed for errors and warnings.
Example: </p>

<pre><code>string scriptDoIt = Path.Combine(_webMatrixHost.WebSite.Path, 
                                 @"WebMatrixTests\DoIt.bat");
var ok = await _executer.RunAsync("cmd.exe", "/c \"" + scriptDoIt + "\"");
</code></pre>

<p><code>RunPowerShellAsync</code>: Execute a powershell command (in the arguments) in a
64 bits PowerShell process on a 64 bits Windows, and in a 32 bits PowerShell
process on a 32 bits Windows. Even if WebMatrix is running as 32 bits app.
Arguments are all the arguments as you would pass to PowerShell.exe.
Output (StdOut, Stderr) is written to output pane
and parsed for errors and warnings.</p>

<p><code>IsRunning</code>: Returns true if executer is executing, false otherwise.</p>

<p><code>Cancel</code>: Cancel the currently running process in the executer.</p>

<p><code>Write</code>, <code>WriteLine</code>: Write output to the Output pane.</p>

<p><code>Initialize</code>: Initialize the executer system. Called by the 
<code>ExecuterFactory.GetExecuter()</code> method. Not for use by extension developer.</p>

<p><code>InitializeTabs</code>: Initialze the tabs for the executer system. also called by
<code>ExecuterFactory.GetExecuter()</code> method. Not for use by extension developer.</p>
        </section>

        <footer>
          Webmatrix.executer is maintained by <a href="https://github.com/MacawNL">MacawNL</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-35175719-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

      </div>
    </div>
  </body>
</html>